 Оглавление

1.  [ Поиск товаров ]( #Product_search )

    1. [Краткое описание поиска](#Краткое_описание_поиска)

    2. [Особенности поиска](#Search_features)

        1. [Смена раскладки](#Change_layout)

        2. [Блочная структура](#Block_structure)

        
        3. [Поиск с приоритетами](#Priority_Search)

        4. [Сортировка по наличию в аптеках](#Сортировка_по_наличию_в_аптеках)
       
        5. [Сортировка по ценам](#Sort_by_price)

        6. [Экранирование спецсимволов](#Escaping_special_characters)

2.  [ Алгоритм поиска ]( #Search_algorithm )

   1.  [ Короткие запросы ]( #Short_queries )

   2.  [ Длинные запросы ]( #Long_queries )

   3.  [ Символы в запросах ]( #Symbols_in_queries )

3.  [ Данные в elasticsearch ]( #Data_in_elasticsearch )

    1. [Описание данных (Способ хранения в elasticsearch)](#Description_of_data)

    2. [Анализаторы поиска](#Search_analyzers)
   
    3.  [ Бэкенд часть ]( #Backend_part )

    4. [Формирование запроса к elasticsearch](#Forming_a_request_to_elasticsearch)

       1. [Формирование поисковой части](#Formation_of_the_search_part)

       2. [Формирование фильтров](#Формирование_фильтров)

       3. [Поиск фильтров](#Search_filters)

<a  name= "Product_search" ></a>
# Поиск товаров

<a  name= "Brief_description_of_the_search" ></a>
## Краткое описание сервиса поиска

Сервис поиска является вебсервисом прослойки между фронтендом (сайт, мобильное приложение) и elasticsearch. Сервис
проводит запросы от фронта, преобразует их в json запрос к elasticsearch, принимает ответ, разбирает его и отдает
про фронтенд

<a  name= "Search_features" ></a>
## Особенности поиска

<a  name= "Изменить_макет" ></a>
### Смена раскладки

Для обработки поисковых источников в неверной раскладке используется следующий алгоритм. Любой поисковый запрос на сайте,
формирует для сервиса elasticsearch два запроса, с оригинальной измененной раскладкой. Из результатов поиска
выбирается более подходящий вариант. Более подробно возможно в разделе «Алгоритм поиска».

<a  name= "Block_structure" ></a>
### Блочная структура.

Поисковая выдача по своей конституции разделения на блоки, каждый из которых соответствует строгим критериям. Более подробно
ключевое слово в разделе "Формирование поисковой части".

<a  name= "Priority_Search" ></a>
###Поиск с приоритетами.

Первый блок выдачи отдается за приоритетные товары по симптомам.

<a  name= "Сортировать_по_наличию_в_аптеках" ></a>
### Сортировка по наличию в аптеках.

Товары внутри одного блока отсортированы по количеству аптек, в которых их можно купить.

<a  name= "Сортировать_по_цене" ></a>
### Сортировка по ценам.

Сортировка по ценам также встречается.

<a  name= "Escaping_special_characters" ></a>
### Снимок спецсимволов

Есть два вида экранирования символов - замена в тексте управляющих символов на время текстовые подстановки.
Одно из них происходит на фронтенде и нужно для того, чтобы формировалась правильная ссылка (символ % заменяется на %25)
. Второй экранирует возможные символы: +, -, =, &, |, !, (, ), {, }, [,], ^, ", ~, * , < ,  > , ?, :, \, / потому что они
спецсимволами Elasticsearch для экранирования символа \. Например, для символа + экранирование
будет выглядеть как \+ .

<a  name= "Алгоритм_поиска" ></a>
# Алгоритм поиска

<a  name= "Short_queries" ></a>
### Короткие запросы

Поиск на сайте не описывает запросы, в которых встречается словосочетание в себе ⩽ 2 символа. Исключением
является запросом b4 (запросы: b4, б4, в4, B4, Б4 и В4 заменяется на «б4 коммерция»). В случае, если запрос состоял из
нескольких слов (где хотя бы одно не меньше 3х символов), поиск осуществляется по всему запросу
слова, состоящие из менее чем 3х символов.

Для примера запрос типа «aa bb cс» не вызывается, запрос типа «aaa bb cc» встречается, не отбрасывая слова меньше
3х символов.

<a  name= "Длинные_запросы" ></a>
### Длинные запросы

Длинными запросами считаются любые запросы, состоящие из более чем 50 символов. При получении запроса более 50 символов,
поиск осуществляется по первому 50, остальная часть запроса провоцируется.

<a  name= "Symbols_in_queries" ></a>
### Символы в запросах

Символы + и - в запросе заменяются на пробел.


<a  name= "Data_in_elasticsearch" ></a>
# Данные в elasticsearch

<a  name= "Описание_данных" ></a>
## Описание данных (Способ хранения в elasticsearch)

Данные в elasticsearch условно можно разбить на множество составляющих:

- Данные о наличии статика в конкретной аптеке
- Данные о товаре, содержит название товара, форму выпуска, производителя и т.д.

Итоговая JSON с информацией по индексу:

``` json
{
  "настройки" : { 
    "анализ" : { 
      "токенизатор" : { 
        "класс" : { 
          "max_token_length" : "15" , 
          "тип" : "классический" 
        },
        "инграмма" : { 
          "max_gram" : "15" , 
          "тип" : "edge_ngram" , 
          "токен_символы" : [ 
            "письмо" ,
            "цифра" ,
            "пунктуация" ,
            "символ"
          ]
        }
      },
      "нормализатор" : { 
        "lowercase_normalizer" : { 
          "фильтр" : [ 
            "нижний регистр"
          ],
          "тип" : "пользовательский" 
        }
      },
      "анализатор" : { 
        "слова_анализатор" : { 
          «токенизатор» : «пробел» , 
          «тип» : «пользовательский» , 
          "char_filter" : [ 
            "мой_символьный_фильтр"
          ],
          "фильтр" : [ 
            "слова" ,
            "нижний регистр" ,
            "уникальный" ,
            "ствол"
          ]
        },
        "по умолчанию" : { 
          «токенизатор» : «пробел» , 
          «тип» : «пользовательский» , 
          "char_filter" : [ 
            "мой_символьный_фильтр"
          ],
          "фильтр" : [ 
            "слова" ,
            "инграмма" ,
            "нижний регистр" ,
            "уникальный"
          ]
        },
        "поиск по умолчанию" : { 
          «токенизатор» : «пробел» , 
          «тип» : «пользовательский» , 
          "фильтр" : [ 
            "нижний регистр" ,
            "уникальный" ,
            "ствол"
          ]
        }
      },
      "char_filter" : { 
        "мой_символьный_фильтр" : { 
          "сопоставления" : [ 
            "( => " ,
            ") => "
          ],
          "тип" : "сопоставление" 
        }
      },
      "фильтр" : { 
        "слова" : { 
          "catenate_words" : "истина" , 
          "сохранить_оригинал" : "истина" , 
          "тип" : "слово_разделитель" 
        },
        "сруб" : { 
          "тип" : "обрезать" , 
          "длина" : "15" 
        },
        "инграмма" : { 
          "max_gram" : "15" , 
          "тип" : "edgeNGram" 
        }
      }
    }
  },
  "отображения" : { 
    "каталог" : { 
      "свойства" : { 
        "адрес" : { 
          "игнорировать_выше" : 256 , 
          "тип" : "ключевое слово" 
        },
        "торговое_имя" : { 
          "search_analyzer" : "по умолчанию_поиск" , 
          "анализатор" : "по умолчанию" , 
          "поля" : { 
            "слова" : { 
              "search_analyzer" : "по умолчанию_поиск" , 
              "анализатор" : "слова_анализатор" , 
              "тип" : "текст" 
            },
            "ключевое слово" : { 
              "игнорировать_выше" : 256 , 
              "тип" : "ключевое слово" 
            }
          },
          "тип" : "текст" 
        },
        "симптомы" : { 
          "тип" : "вложенный" , 
          "свойства" : { 
            "имя" : { 
              "тип" : "ключевое слово" , 
              "игнорировать_выше" : 256 , 
              «нормализатор» : «нижний регистр_нормализатор» 
            },
            "вес" : { 
              "тип" : "целое число" 
            }
          }
        },
        "суперсток" : { 
          "тип" : "длинный" 
        },
        "подраздел" : { 
          "search_analyzer" : "по умолчанию_поиск" , 
          "анализатор" : "по умолчанию" , 
          "поля" : { 
            "ключевое слово" : { 
              "игнорировать_выше" : 256 , 
              "тип" : "ключевое слово" 
            }
          },
          "тип" : "текст" 
        },
        "сток" : { 
          "тип" : "длинный" 
        },
        "раздел" : { 
          "search_analyzer" : "по умолчанию_поиск" , 
          "анализатор" : "по умолчанию" , 
          "поля" : { 
            "ключевое слово" : { 
              "игнорировать_выше" : 256 , 
              "тип" : "ключевое слово" 
            }
          },
          "тип" : "текст" 
        },
        "search_rang_symptoms" : { 
          "тип" : "длинный" 
        },
        "ранг_поиска" : { 
          "игнорировать_выше" : 256 , 
          "тип" : "ключевое слово" 
        },
        "рзв" : { 
          "search_analyzer" : "по умолчанию_поиск" , 
          "анализатор" : "по умолчанию" , 
          "поля" : { 
            "ключевое слово" : { 
              "игнорировать_выше" : 256 , 
              "тип" : "ключевое слово" 
            }
          },
          "тип" : "текст" 
        },
        "цена" : { 
          "тип" : "двойной" 
        },
        "идентификатор_фарм" : { 
          "игнорировать_выше" : 256 , 
          "тип" : "ключевое слово" 
        },
        "фарм" : { 
          "отношения" : { 
            "продукт" : "фарм" 
          },
          "eager_global_ordinals" : правда , 
          "тип" : "присоединиться" 
        },
        "осно" : { 
          "search_analyzer" : "по умолчанию_поиск" , 
          "анализатор" : "по умолчанию" , 
          "поля" : { 
            "ключевое слово" : { 
              "игнорировать_выше" : 256 , 
              "тип" : "ключевое слово" 
            }
          },
          "тип" : "текст" 
        },
        "имя" : { 
          "search_analyzer" : "по умолчанию_поиск" , 
          "анализатор" : "по умолчанию" , 
          "поля" : { 
            "слова" : { 
              "search_analyzer" : "по умолчанию_поиск" , 
              "анализатор" : "слова_анализатор" , 
              "тип" : "текст" 
            },
            "ключевое слово" : { 
              "игнорировать_выше" : 256 , 
              "тип" : "ключевое слово" 
            }
          },
          "тип" : "текст" 
        },
        "мнн" : { 
          "search_analyzer" : "по умолчанию_поиск" , 
          "анализатор" : "по умолчанию" , 
          "поля" : { 
            "слова" : { 
              "search_analyzer" : "по умолчанию_поиск" , 
              "анализатор" : "слова_анализатор" , 
              "тип" : "текст" 
            },
            "ключевое слово" : { 
              "игнорировать_выше" : 256 , 
              "тип" : "ключевое слово" 
            }
          },
          "тип" : "текст" 
        },
        "создатель" : { 
          "игнорировать_выше" : 256 , 
          "тип" : "ключевое слово" 
        },
        "лат_название" : { 
          "поля" : { 
            "слова" : { 
              "search_analyzer" : "по умолчанию_поиск" , 
              "анализатор" : "слова_анализатор" , 
              "тип" : "текст" 
            }
          },
          "search_analyzer" : "по умолчанию_поиск" , 
          "анализатор" : "по умолчанию" , 
          "тип" : "текст" 
        },
        "идтовар" : { 
          "игнорировать_выше" : 256 , 
          "тип" : "ключевое слово" 
        },
        "идентификатор" : { 
          "игнорировать_выше" : 256 , 
          "тип" : "ключевое слово" 
        },
        "форма" : { 
          "игнорировать_выше" : 256 , 
          "тип" : "ключевое слово" 
        },
        "ean13" : { 
          "search_analyzer" : "по умолчанию_поиск" , 
          "анализатор" : "по умолчанию" , 
          "поля" : { 
            "ключевое слово" : { 
              "игнорировать_выше" : 256 , 
              "тип" : "ключевое слово" 
            }
          },
          "тип" : "текст" 
        },
        "продолжение" : { 
          "search_analyzer" : "по умолчанию_поиск" , 
          "анализатор" : "по умолчанию" , 
          "поля" : { 
            "ключевое слово" : { 
              "игнорировать_выше" : 256 , 
              "тип" : "ключевое слово" 
            }
          },
          "тип" : "текст" 
        }
      }
    }
  }
}
```

Из данного JSON можно выделить две части информации об остатках и информации о товарах. Поле фарм, по дому можно
отличить какая информация содержится в JSON.

Пример части JSON с информацией об остатках товаров:

``` json
{
    "_источник" : { 
        "фарм" : { 
            «родитель» : «179833» , 
            "название" : "фарм" 
        },
        "цена" : 0 , 
        "id" : "179833" , 
        "сток" : 0 , 
        "фарм_ид" : "7407" 
    }
}
```

- pharm_id - id аптеки, в которой находится этот край
- сток - Остаток товара в аптеке
- цена - Цена товара в аптеке (соответствует онлайн цене в отделении министерства)
- id - Id \_ mp код товара. Используется для выдачи.
- родитель - Id \_ mp товара

Пример части JSON с информацией о товарах:

``` json
{
  "_источник" : { 
    "url" : "/catalog/лекарства-и-бады/здоровое-сердце-и-сосуды/карведилол-акрихин-таб-12-5мг-30" , 
    "супер_сток" : 0 , 
    "ранг_поиска" : 0 , 
    "мнн" : [ 
      "Карведилол"
    ],
    "симптомы" : [ 
      {
        "название" : "Насморк" , 
        "вес" : 97 
      }
    ],
    "форма" : "Таблетки" , 
    "производитель" : "АКРИХИН ХФК АО" , 
    "лат_имя" : [], 
    "id" : "159780" , 
    "ean13" : [ 
      "4601969007480"
    ],
    "цена" : [ 
      189
    ],
    "торговое_имя" : [], 
    «фарм» : «продукт» , 
    "название" : "Карведилол Акрихин таблетки 12,5мг, №30 Акрихин" 
  },
  "_счет" : 2 , 
  "_версия" : 1 , 
  "_id" : "159780" , 
  "_type" : "каталог" , 
  "_index" : "ве-сайт-поиск" 
}
```

- id - id_mp - Код товара. Используется для выдачи.
- название - Полное название товара. Используется для поиска и выдачи.
- lat_name - Название товара на латинице. Используется для поиска.
- trade_name - Коммерческое наименование товара. Используется для поиска.
- форма - Форма выпуска. Используется для выдачи и фильтрации.
- maker- Производитель. Используется для выдачи и фильтрации.
- mnn - Активное вещество. Используется для поиска, выдачи и фильтрации.
- search_rang - Поле для приоритета при поиске по мнн.
- ean13 - Штрих-код товара. Поле для поиска по штрих-коду.
- url - URL товара. Используется в выдаче.
- цена - Цена товара в аптеке (соответствует онлайн цене в отделении министерства)
- idtovar - Аптечный идентификатор товара.
- signal.name – Поле для поиска по симптомам.
- симптомы.масса - Поле для приоритета поиска по симптомам.
- подраздел - ID подсекции товара. Не используется.
- section - ID секции товара, в настоящее время не используется.

<a  name= "Search_analyzers" ></a>
## Анализаторы поиска

Для всех полей, которые используются для указанных поисковых три анализаторов: default, default_search и words_analizer, normalizer.
Разбор исходных данных - words_analizer.

``` json
{
  "токенизатор" : { 
    "инграмма" : { 
      "max_gram" : "15" , 
      "тип" : "edge_ngram" , 
      "токен_символы" : [ 
        "письмо" ,
        "цифра" ,
        "пунктуация" ,
        "символ"
      ]
    }
  },
  "анализатор" : { 
    "слова_анализатор" : { 
      «токенизатор» : «пробел» , 
      «тип» : «пользовательский» , 
      "char_filter" : [ 
        "мой_символьный_фильтр"
      ],
      "фильтр" : [ 
        "слова" ,
        "нижний регистр" ,
        "уникальный" ,
        "ствол"
      ]
    }
  },
  "char_filter" : { 
    "мой_символьный_фильтр" : { 
      "сопоставления" : [ 
        "( => " ,
        ") => "
      ],
      "тип" : "сопоставление" 
    }
  },
  "фильтр" : { 
    "слова" : { 
      "catenate_words" : "истина" , 
      "сохранить_оригинал" : "истина" , 
      "тип" : "слово_разделитель" 
    },
    "сруб" : { 
      "тип" : "обрезать" , 
      "длина" : "15" 
    }
  }
}
```

tokenizer разбирает поисковый запрос по пробелам (пробелы)

filter разбивает на слова (слова) (например, Но-шпа разбивается на [Но-шпа, Ношпа, Но, шпа]). Частью слова являются
буквы, числа, знаки препинания и символы, кроме пробелов (буква, цифра, знак препинания, символ). Далее все представленные токены
к общему регистру (строчные буквы) и учету повторения (уникальные)

char-filter все ( и )

Разбор исходных данных – по умолчанию.

``` json
{
  "анализатор" : { 
    "по умолчанию" : { 
      «токенизатор» : «пробел» , 
      «тип» : «пользовательский» , 
      "char_filter" : [ 
        "мой_символьный_фильтр"
      ],
      "фильтр" : [ 
        "слова" ,
        "инграмма" ,
        "нижний регистр" ,
        "уникальный"
      ]
    }
  },
  "фильтр" : { 
    "слова" : { 
      "сохранить_оригинал" : правда , 
      "catenate_words" : правда , 
      "тип" : "слово_разделитель" 
    },
    "инграмма" : { 
      "тип" : "edgeNGram" , 
      "макс_грамм" : "15" 
    }
  }
}
```

tokenizer разбирает поисковый запрос по пробелам (пробелы)

filter разбивается на слова (слова) (например, Но-шпа разбивается на [Но-шпа, Ношпа, Но, шпа]), после разбираем их как
префиксы (энграммы) найдены до 15 символов (max_gram). Частью слова являются буквы, числа, знаки препинания и символы, кроме
пробелов (буква, цифра, знак препинания, символ). Например нуро1!& разбирается в [н, ну, нур, нуро, нуро1, нуро1!, нуро1!&]
. Далее все токены к частному регистру (строчные буквы) и обходу повторения (уникальные)

char-filter все ( и )

Разбор поисковой строки - search_analyzer

``` json
{
  "анализатор" : { 
    "поиск по умолчанию" : { 
      «токенизатор» : «пробел» , 
      «тип» : «пользовательский» , 
      "фильтр" : [ 
        "нижний регистр" ,
        "уникальный" ,
        "ствол"
      ]
    }
  },
  "фильтр" : { 
    "сруб" : { 
      "тип" : "обрезать" , 
      "длина" : "15" 
    }
  }
}
```

Токенизатор разбирает поисковый запрос по пробелам (пробелы)

отфильтровать все токены к общему регистру (строчные), обход повторения (уникальный), обрезать все токены до 15
символы.

нормализатор

``` json
     "нормализатор" : { 
        "lowercase_normalizer" : { 
          "фильтр" : [ 
            "нижний регистр"
          ],
          "тип" : "пользовательский" 
        }
      }
```
Он предъявляет все запросы к частному регистру.

<a  name= "Backend_part" ></a>
## Бэкенд часть

На веб-сервисе поиска посылок запрос такого вида:

``` json
{
    "идентификатор сеанса" : "" , 
    "сортировать" : "" , 
    "мин" : "0" , 
    «макс» : «0» , 
    "мнн" : [ 
        {
            «показать» : «правда» , 
            «ч» : «правда» , 
            "doc_count" : "2" , 
            "ключ" : "Парацетамол" 
        }
    ],
    "ean13" : "" , 
    "рев" : "правда" , 
    «тип» : «0» , 
    "от" : "0" , 
    "размер" : "24" , 
    "q" : "нурофен" 
}
```

- q - значительный поисковый запрос
- размер - количество товаров, которые необходимо вернуть
- from - с какой позиции начать искать
- тип - булева переменная, 0 - ничего не происходит, 2 - возникает поисковый запрос в фильтрах по действующему воздействию (
  мин)
- rev - булева переменная, закрывающая, надо ли закрыть смену раскладки пользователя
- ean13 - штрихкод
- mnn, form, maker - фильтрация по полям действующего вещества, форма выпуска и производитель соответственно (в
  зависимости от запроса подставляется мнн и/или форма и/или производитель)
- ключ - ключ фильтрации
- doc_count - количество товаров, соответствующих этому фильтру
- ch - выбран ли фильтр
- показать - надо ли этот фильтр показать
- max - фильтрация по ожидаемой цене
- мин - фильтрация по минимальной цене
- sort- сортировка (если есть)
- SessionId - необязательное поле, помогающее определить с нодой elasticsearch, в которую пойдёт запрос

Оригинальный запрос сразу обрезается до 50 символов, а + и - заменяется на пробел. Две недели новых перемен:

- query_front - поисковый запрос, который нужно отобразить в поисковой строке

- query_filter - реальный поисковый запрос, который в дальнейшем будет развиваться в запросе на получение фильтров.
  изначально эти переменные складываются в исходной строке поиска. Дальше отрабатывает остатки поб4, если
  оригинальный запрос это:b4, b4, в4, B4, B4 и В4 - то он и значение полязапроса \_ filterзаменяется на «b4 коммерция».
  После этого происходит проверка по короткому запросу: если в первоначальном запросе нет ни одного слова длиннее двух
  символы, то возвращает ответ:

``` json
{
    "IS_REVERTED" : ложь , 
    "СОРТИРОВАТЬ" : ноль , 
    «QUERY_FRONT» : «фк фк фк » , 
    "QUERY_FILTER" : "фк ФК ФК " , 
    "СООБЩЕНИЕ" : "Поисковый запрос должен быть не менее 3 символов!" 
}
```

- from - с какой позиции надо будет искать при встрече на месте ещё
- разбить на страницы - надо ли обрисовывать элемент ещё
- isReverted - была изменена раскладка
- всего - общее количество результатов поиска
- max_score - наивысшее значение рейтинга в реестре
- товары- значительный результат поиска

Внешний вид элемента товара:

``` json

{
    «Алкоголь» : ложь , 
    «исТермо» : ложь , 
    "тип_ограничения" : 0 , 
    "количество" : 5 , 
    "MAX_PRICE" : ложь , 
    "ДОСТАВКА" : ложь , 
    "ВИТАМИКС" : ложь , 
    "ЗНАЧКИ" : [], 
    "STRONG_RECIPE" : ложь , 
    "РЕЦЕПТ" : ложь , 
    "ЦЕНА" : 230 , 
    «ФКУ» : ложь , 
    "PREVIEW_PICTURE" : "https://pics.vitaexpress.ru/public/images/medium/146323.jpg" , 
    "URL" : "/каталог/лекарства-и-бады/обезболивающие/нурофен-таб-200мг-20/" , 
    "НАЗВАНИЕ" : "Нурофен таблетки 200мг, №20" , 
    "XML_ID" : 146323 , 
    "ID" : 41325 
}
```

- ID - ID товара из 1С-Битрикс
- XML \_ ID - ID \_ MP товара
- ИМЯ - Название товара
- URL - Ссылка на товар
- ПРЕДПРОСМОТР \_ ФОТО - Картинка товара
- ФКУ – Маркер «Доступен только в аптеке»
- ЦЕНА - Цена товара
- RECIPE - Шильдик рецептурного препарата
- СИЛЬНЫЙ РЕЦЕПТ - Шильдик строго рецептурного препарата
- ICONS - Массив с шильдиками для акционных товаров
- ВИТАМИКС - Путь до шильдика Витамикс
- ДОСТАВКА - Булево значение, маркер доставки (товар доступен для доставки клиенту)
- МАКС . \_ ЦЕНА - Зачеркнутая цена
- количество - Максимальное число товаров, доступное для заказа
- limit \_ type - Поле не используется
- isTermo - Маркер термолабильности
- isAlcohol - Маркер спиртосодержащего товара

Далее из результатов поиска запрашиваются id товаров, и по ним запрашиваются данные в 1С-Битрикс. Общий вид результата,
далее:

``` json
 {
    "VITAMIX_LOGO" : "/upload/iblock/c62/c62e5769befb97925665f5b7625cdd89.svg" , 
    "SVG_SPRITE" : "102156415" , 
    "ВСЕГО" : 26 , 
    "IS_REVERTED" : ложь , 
    "СОРТИРОВАТЬ" : { 
        "направление" : "описание" , 
        "поле" : "_score" 
    },
	«ТОВАРЫ» : [{ … }, { … }, { … }, { … }, { … }, … ],      
    "QUERY_FRONT" : "парацетамол" , 
    "QUERY_FILTER" : "парацетамол" , 
    "СООБЩЕНИЕ" : "" 
}
```

- СООБЩЕНИЕ - сообщение, которое необходимо получить перед обнаружением
- QUERY_FILTER - поисковый запрос, который нужно отправить в поисковые фильтры
- QUERY_FRONT - поисковый запрос, который нужно отрисовывать
- SORT - сортировка результата
- IS_REVERTED - маркер смены раскладки
- ВСЕГО - количество результатов поиска
- ТОВАРЫ - товары
- SVG_SPRITE - код отображения цены
- VITAMIX_LOGO - ссылка на шильдик Витамикс

<a  name= "Forming_a_request_to_elasticsearch" ></a>
## Формирование запроса к elasticsearch

<a  name= "Formation_of_the_search_part" ></a>
### Формирование поисковой части

Поисковый запрос можно разделить на две части:

1. Вычисление количества аптек, в наличии доступных товаров,
2. Блоки.

Вместе эти две части составляют `score`, по которому по умолчанию сортируются товары в поисковой выдаче. Формируется он по
далее по логике. Наличие в аптеке прибавляет к `счету` единицу. Попадание же в блок прибавляет к `score` числу
равное: (количество запрашиваемых аптек) * (номер блока, в чью выдачу попал этот товар).

Блоки имеют значение (блоки для использования в порядке от большего числа к меньшему):

1 - 100. Поиск по симптомам без ошибок и с приоритетом по номеру блока.

101. Поиск по всем в мнн с ошибками с приоритетом (Работает на сайте и в мп, но не работает в быстром поиске на
     сайте).
102. Поиск по lat_name без ошибок.
103. Поиск по всем упоминаниям в имени или по всем упоминаниям в mnn без ошибок
104. Поиск по всем именам с ошибками
105. Поиск по приоритетному слову как префикс в имени
106. Поиск по приоритетному слову в названии c ошибками
107. Поиск чистого имени в запросе
108. Поиск чистого запроса в mnn как префикс
109. Поиск чистого запроса в mnn с ошибками
110. Поиск одного чистого запроса по имени, lat_name, trade_name, mnn c ошибкой
111. Поиск чистого запроса по имени, lat_name, trade_name, mnn как префикс

На самом деле вычисление 'score' для блоков раскрывается на 2 этапа. Отдельно рассчитывается «счет» по симптомам и отдельно по всем
энергетическим блокам. После этого происходит их увеличение.

В формате json часть с западной аптекой выглядит так:

``` json
{
  "has_child" : { 
    "запрос" : { 
      "постоянный_счет" : { 
        "фильтр" : { 
          "логическое" : { 
            "фильтр" : [ 
              {
                "термины" : { 
                  "фарм_идентификатор" : [ 
                    7475 ,
                    7458 ,
                    7419
                  ]
                }
              },
              {
                "диапазон" : { 
                  "сток" : { 
                    "гт" : 0 
                  }
                }
              }
            ]
          }
        }
      }
    },
    "score_mode" : "сумма" , 
    "тип" : "фарм" 
  }
}
```

Часть с симптомами выглядит так:

``` json

  "вложенный" : { 
    «путь» : «симптомы» , 
    "запрос" : { 
      "function_score" : { 
        "запрос" : { 
          "совпадение" : { 
            "симптомы.название" : { 
              "запрос" : "температура" 
            }
          }
        },
        "score_mode" : "максимум" , 
        "boost_mode" : "заменить" , 
        "функции" : [ 
          {
            "script_score" : { 
              "скрипт" : { 
                "источник" : "160 * doc['symptoms.weight'].value + 2080" 
              }
            }
          }
        ]
      }
    }
  }

```

А блоки так:

``` json
"function_score" : { 
                  "запрос" : { 
                    "логическое" : {} 
                  },
                  "минимальный_счет" : 161,0 , 
                  "score_mode" : "первый" , 
                  "boost_mode" : "сумма" , 
                  "функции" : [ 
                    {
                      "вес" : 1920.0 , 
                      "фильтр" : { 
                        "совпадение" : { 
                          "lat_name.words" : { 
                            "запрос" : "температура" , 
                            "оператор" : "И" 
                          }
                        }
                      }
                    },
                    {
                      "вес" : 1760.0 , 
                      "фильтр" : { 
                        "совпадение" : { 
                          "имя.слова" : { 
                            "запрос" : "температура" , 
                            "оператор" : "И" 
                          }
                        }
                      }
                    },
                    {
                      "вес" : 1600.0 , 
                      "фильтр" : { 
                        "совпадение" : { 
                          "торговое_название.слова" : { 
                            "запрос" : "температура" , 
                            "оператор" : "И" 
                          }
                        }
                      }
                    },
                    {
                      "вес" : 1440.0 , 
                      "фильтр" : { 
                        "совпадение" : { 
                          "имя.слова" : { 
                            "запрос" : "температура" , 
                            «нечеткость» : «АВТО: 4,6» , 
                            "оператор" : "И" 
                          }
                        }
                      }
                    },
                    {
                      «вес» : 1280,0 , 
                      "фильтр" : { 
                        "совпадение" : { 
                          "торговое_название.слова" : { 
                            "запрос" : "температура" , 
                            «нечеткость» : «АВТО: 4,6» , 
                            "оператор" : "И" 
                          }
                        }
                      }
                    },
                    {
                      "вес" : 1120.0 , 
                      "фильтр" : { 
                        "совпадение" : { 
                          "имя" : { 
                            "запрос" : "температура" 
                          }
                        }
                      }
                    },
                    {
                      «вес» : 960,0 , 
                      "фильтр" : { 
                        "совпадение" : { 
                          "имя.слова" : { 
                            "запрос" : "температура" , 
                            «нечеткость» : «АВТО: 4,6» 
                          }
                        }
                      }
                    },
                    {
                      «вес» : 800,0 , 
                      "фильтр" : { 
                        "совпадение" : { 
                          "имя" : { 
                            "запрос" : "температура" 
                          }
                        }
                      }
                    },
                    {
                      «вес» : 640,0 , 
                      "фильтр" : { 
                        "совпадение" : { 
                          "мнн" : { 
                            "запрос" : "температура" 
                          }
                        }
                      }
                    },
                    {
                      «вес» : 480,0 , 
                      "фильтр" : { 
                        "совпадение" : { 
                          "мнн.слова" : { 
                            "запрос" : "температура" , 
                            «нечеткость» : «АВТО: 4,6» 
                          }
                        }
                      }
                    },
                    {
                      «вес» : 320,0 , 
                      "фильтр" : { 
                        "мультиматч" : { 
                          "запрос" : "температура" , 
                          "поля" : [ 
                            "имя.слова" ,
                            "мнн.слова" ,
                            "лат_название.слова" ,
                            "торговое_имя.слова"
                          ],
                          «нечеткость» : «АВТО: 4,6» 
                        }
                      }
                    },
                    {
                      «вес» : 160,0 , 
                      "фильтр" : { 
                        "мультиматч" : { 
                          "запрос" : "температура" , 
                          "поля" : [ 
                            "имя" ,
                            "мнн" ,
                            "лат_название" ,
                            "торговое_имя"
                          ]
                        }
                      }
                    }
                  ]
                }
              }
```

После этого вычисляется 'score', функция dismax и выявляет большее 'score'.

``` json
"dis_max" : { 
  "запросы" : [ 
    {
      "function_score" : - 'оценка' всех блоков кроме поиска по симптомам        
    },
    {
      "nested" : - 'score' поиск по симптомам     
    }
  ]
}
```

<a  name= "Формирование_фильтров" ></a>
### Формирование фильтров

Фильтр по наличию, участие всегда:

``` json
{
    "has_child" : { 
        "запрос" : { 
            "логическое" : { 
                "фильтр" : [ 
                    {
                        "диапазон" : { 
                            "сток" : { 
                                "гт" : 0 
                            }
                        }
                    },
                    {
                        "термины" : { 
                            "фарм_идентификатор" : [ 
                                1335 ,
                                12 ,
                                143
                            ]
                        }
                    },
                    {
                        "диапазон" : { 
                            "цена" : { 
                                "лте" : 150 , 
                                "гте" : 0 
                            }
                        }
                    }
                ]
            }
        },
        "внутренние_хиты" : { 
            "размер" : 1 
        },
        "тип" : "фарм" 
    }
}
```

С его помощью происходит проверка наличия товара, хотя бы в одной из аптек, (в случае наличия [1335, 12, 143]) а
Применение данных о товарах именно в аптеках в пределах 0. В этот же момент
формируются фильтры по цене, в соответствии с ростом, фильтруется по оценочной и ожидаемой цене 0 и 150 соответственно (
qte и lte)Отдельно образуются фильтры по действующему воздействию (mnn):

``` json
[
    {
        "срок" : { 
            "мнн" : "Ибупрофен" 
        }
    },
    {
        "срок" : { 
            "мнн" : "Аскорил" 
        }
    }
] 
```

Фильтры образуются по их выбору, потому что у разной логики объединение. По действующему воздействию (млн) товар
должен соответствовать всем выбранным фильтрам, а по форме выпуска (форма) и производителю (производителю) хотя бы один.

<a  name= "Поиск_фильтров" ></a>
## Поиск фильтров

Поиск фильтров можно описать как агрегацию поиска товаров. То есть на основе результатов поиска, собирается все поля
mnn, form and maker (действующее вещество, форма выпуска и производства соответственно), и передаются на фронтенд сайта,
для отображения фильтров на странице Результаты поиска.

Теперь рассмотрим этот вопрос более подробно. Бэкенд сайта не агрегирует результаты поиска, а формирует запрос к
эластичный поиск. В первую очередь необходимо обнаружить, что поисковая часть поисковых фильтров предназначена для поисковой части поиска.
товаров (см. раздел Алгоритм поиска), поэтому ее разбирать не будем.

Фильтрация для предварительного поискового запроса. Сделано это для того, чтобы получить полные данные для
формирование панели фильтрации на странице Результаты поиска. Применение фильтра на фронтенде, панель фильтрации
должна быть обновлена ​​в соответствии с применяемыми фильтрами.

Есть несколько агрегаций, которые идут с общим префиксом all, а именно запросы, которые относятся к чистому
неотфильтрованному запросу:

``` json
[
    {
        "all_mnns" : { 
            "термины" : { 
                "размер" : 500 , 
                "поле" : "mnn.keyword" 
            }
        }
    },
    {
        "все_производители" : { 
            "термины" : { 
                "размер" : 500 , 
                "поле" : "создатель" 
            }
        }
    },
    {
        "все_формы" : { 
            "термины" : { 
                "размер" : 500 , 
                "поле" : "форма" 
            }
        }
    },
    {
        "все_макс" : { 
            "аггс" : { 
                "Ч" : { 
                    "макс" : { 
                        "поле" : "цена" 
                    }
                }
            },
            "дети" : { 
                "тип" : "фарм" 
            }
        }
    },
    {
        "все_мин" : { 
            "аггс" : { 
                "Ч" : { 
                    "мин" : { 
                        "поле" : "цена" 
                    }
                }
            },
            "дети" : { 
                "тип" : "фарм" 
            }
        }
    }
]
```

В случае с mnn, maker и form это сбор значений из соответствующих полей, а в случае со all \_ min и all \_ max это сбор
минимального и максимального значения данных об остатках.

Следующие случаи и другие агрегации, которые необходимы как раз для того, чтобы отфильтровывать получение результата. То есть
только те фильтры, которые можно применять для наблюдения за выдачей.

В результате нижеследующего поиска фильтруется по действующему открытому (mnn), формируемому выпуску (форма) и наличию (более
подробно разрешено в разделе «Формирование фильтров»), в результате чего из него выпадают все производители (производитель):

``` json
{
    "создатели" : { 
        "фильтр" : { 
            "логическое" : { 
                "аггс" : { 
                    "вал" : { 
                        "термины" : { 
                            "размер" : 500 , 
                            "поле" : "создатель" 
                        }
                    }
                },
                "должен" : [ 
                    {
                        "логическое" : { 
                            "должен" : "Фильтрыпо мнн" 
                        }
                    },
                    {
                        "логическое" : { 
                            "должен" : "Фильтрыпо форме" 
                        }
                    },
                    {
                        "логическое" : { 
                            "должен" : "Фильтры по наличию" 
                        }
                    }
                ]
            }
        }
    }
}
```

Аналогично выглядит запрос для формы выпуска (форма), разница только в том, что результаты фильтруются не по форме
выпуск (форма) а по производителю (производителю):

``` json
{
    "формы" : { 
        "фильтр" : { 
            "логическое" : { 
                "аггс" : { 
                    "вал" : { 
                        "термины" : { 
                            "размер" : 500 , 
                            "поле" : "форма" 
                        }
                    }
                },
                "должен" : [ 
                    {
                        "логическое" : { 
                            "должен" : "Фильтрыпо мнн" 
                        }
                    },
                    {
                        "логическое" : { 
                            "должен" : "Фильтрыпо производитель" 
                        }
                    },
                    {
                        "логическое" : { 
                            "должен" : "Фильтры по наличию" 
                        }
                    }
                ]
            }
        }
    }
}
```

Запрос по действующему заболеванию (mnn)отличается, потому что для действия вещества (mnn)используется конъюнкцией:

``` json
{
    "мнн" : { 
        "фильтр" : { 
            "логическое" : { 
                "аггс" : { 
                    "вал" : { 
                        "термины" : { 
                            "размер" : 12500 , 
                            "поле" : "мнн" 
                        }
                    }
                },
                "должен" : [ 
                    {
                        "логическое" : { 
                            "должен" : "Фильтрыпо мнн" 
                        }
                    },
                    {
                        "логическое" : { 
                            "должен" : "Фильтрыпо форме" 
                        }
                    },
                    {
                        "логическое" : { 
                            "должен" : "Фильтрыпо производитель" 
                        }
                    },
                    {
                        "логическое" : { 
                            "должен" : "Фильтры по наличию" 
                        }
                    }
                ]
            }
        }
    }
}
```

В запросе для цен необходимо агрегировать регистрацию о наличии данного товара в аптеках (более подробно в разделе
«Формирование фильтров»), а не поля из записей о товарах (мнн, производитель, форма):

``` json
{
    "аггс" : { 
        "Ч" : { 
            "аггс" : { 
                "сток" : { 
                    "аггс" : { 
                        "мин" : { 
                            "мин" : { 
                                "поле" : "цена" 
                            }
                        },
                        "макс" : { 
                            "макс" : { 
                                "поле" : "цена" 
                            }
                        }
                    },
                    "фильтр" : { 
                        "логическое" : { 
                            "фильтр" : "Фильтрыпоналичию" 
                        }
                    }
                }
            },
            "дети" : { 
                "тип" : "фарм" 
            }
        }
    },
    "цена" : { 
        "фильтр" : { 
            "логическое" : { 
                "должен" : [ 
                    {
                        "логическое" : { 
                            "должен" : "Фильтрыпо производитель" 
                        }
                    },
                    {
                        "логическое" : { 
                            "следует" : "Фильрыпо форме" 
                        }
                    },
                    {
                        "логическое" : { 
                            "должен" : "Фильтыпо мнн" 
                        }
                    }
                ]
            }
        }
    }
}
```
